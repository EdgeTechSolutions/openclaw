<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 700" font-family="Inter, -apple-system, sans-serif" font-size="12">
  <defs>
    <filter id="s" x="-4%" y="-4%" width="108%" height="112%"><feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.1"/></filter>
    <marker id="a" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#475569"/></marker>
    <marker id="ab" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#3b82f6"/></marker>
  </defs>
  <style>
    .t { font-size: 16px; font-weight: 700; fill: #1e293b; }
    .bl { font-size: 11px; font-weight: 600; fill: #1e293b; }
    .bs { font-size: 10px; fill: #64748b; }
    .step { font-size: 10px; font-weight: 700; fill: white; }
  </style>
  <rect width="800" height="700" fill="#f8fafc" rx="8"/>
  <text x="400" y="30" text-anchor="middle" class="t">Agent Loop &amp; Message Processing Pipeline</text>

  <!-- Step 1: Inbound Message -->
  <circle cx="60" cy="70" r="14" fill="#3b82f6"/><text x="60" y="74" text-anchor="middle" class="step">1</text>
  <rect x="80" y="52" width="300" height="40" rx="6" fill="#eff6ff" stroke="#93c5fd" filter="url(#s)"/>
  <text x="230" y="70" text-anchor="middle" class="bl">Inbound Message (Channel → Gateway)</text>
  <text x="230" y="83" text-anchor="middle" class="bs">Debounce (inbound.debounceMs) → DM/group policy check</text>

  <!-- Step 2: Route -->
  <circle cx="60" cy="120" r="14" fill="#3b82f6"/><text x="60" y="124" text-anchor="middle" class="step">2</text>
  <rect x="80" y="102" width="300" height="40" rx="6" fill="#f0fdf4" stroke="#86efac" filter="url(#s)"/>
  <text x="230" y="120" text-anchor="middle" class="bl">Route: Binding → Agent → Session Key</text>
  <text x="230" y="133" text-anchor="middle" class="bs">dmScope / group isolation / identityLinks</text>

  <!-- Step 3: Queue Check -->
  <circle cx="60" cy="170" r="14" fill="#3b82f6"/><text x="60" y="174" text-anchor="middle" class="step">3</text>
  <rect x="80" y="152" width="300" height="40" rx="6" fill="#fef3c7" stroke="#fbbf24" filter="url(#s)"/>
  <text x="230" y="170" text-anchor="middle" class="bl">Queue Check (steer / collect / followup)</text>
  <text x="230" y="183" text-anchor="middle" class="bs">Agent busy? → debounce + enqueue or steer</text>

  <!-- Step 4: Session Load -->
  <circle cx="60" cy="220" r="14" fill="#3b82f6"/><text x="60" y="224" text-anchor="middle" class="step">4</text>
  <rect x="80" y="202" width="300" height="40" rx="6" fill="#ede9fe" stroke="#c4b5fd" filter="url(#s)"/>
  <text x="230" y="220" text-anchor="middle" class="bl">Session Load / Create</text>
  <text x="230" y="233" text-anchor="middle" class="bs">Reset check (daily/idle) → load JSONL transcript</text>

  <!-- Step 5: Context Build -->
  <circle cx="60" cy="280" r="14" fill="#3b82f6"/><text x="60" y="284" text-anchor="middle" class="step">5</text>
  <rect x="80" y="256" width="300" height="50" rx="6" fill="#ecfeff" stroke="#67e8f9" filter="url(#s)"/>
  <text x="230" y="274" text-anchor="middle" class="bl">Build Context Window</text>
  <text x="230" y="287" text-anchor="middle" class="bs">System prompt + workspace files (AGENTS.md, SOUL.md…)</text>
  <text x="230" y="299" text-anchor="middle" class="bs">+ session history + pruning + memory search</text>

  <!-- Step 6: LLM Call -->
  <circle cx="60" cy="340" r="14" fill="#ef4444"/><text x="60" y="344" text-anchor="middle" class="step">6</text>
  <rect x="80" y="318" width="300" height="48" rx="6" fill="#fce7f3" stroke="#f9a8d4" filter="url(#s)"/>
  <text x="230" y="336" text-anchor="middle" class="bl">LLM API Call (Streaming)</text>
  <text x="230" y="349" text-anchor="middle" class="bs">Anthropic / OpenAI / Google + failover chain</text>
  <text x="230" y="361" text-anchor="middle" class="bs">Typing indicators + block streaming to channel</text>

  <!-- Step 7: Tool Execution Loop -->
  <circle cx="60" cy="404" r="14" fill="#f97316"/><text x="60" y="408" text-anchor="middle" class="step">7</text>
  <rect x="80" y="378" width="680" height="110" rx="8" fill="#fff7ed" stroke="#fdba74" filter="url(#s)"/>
  <text x="420" y="396" text-anchor="middle" class="bl">Tool Execution Loop</text>

  <!-- Tool sub-steps -->
  <rect x="100" y="404" width="140" height="36" rx="4" fill="#fed7aa"/>
  <text x="170" y="420" text-anchor="middle" class="bl">Parse tool_use</text>
  <text x="170" y="432" text-anchor="middle" class="bs">from LLM response</text>

  <rect x="260" y="404" width="140" height="36" rx="4" fill="#fed7aa"/>
  <text x="330" y="420" text-anchor="middle" class="bl">Execute Tool</text>
  <text x="330" y="432" text-anchor="middle" class="bs">read/exec/edit/write…</text>

  <rect x="420" y="404" width="140" height="36" rx="4" fill="#fed7aa"/>
  <text x="490" y="420" text-anchor="middle" class="bl">Check Queue</text>
  <text x="490" y="432" text-anchor="middle" class="bs">steer: inject msg?</text>

  <rect x="580" y="404" width="160" height="36" rx="4" fill="#fed7aa"/>
  <text x="660" y="420" text-anchor="middle" class="bl">Return tool_result</text>
  <text x="660" y="432" text-anchor="middle" class="bs">→ next LLM turn</text>

  <!-- Loop arrow -->
  <path d="M740,422 Q760,422 760,460 Q760,478 420,478 Q100,478 100,460 Q100,445 100,440" stroke="#f97316" stroke-width="1.5" fill="none" marker-end="url(#a)" stroke-dasharray="4,3"/>
  <text x="430" y="472" text-anchor="middle" class="bs" fill="#ea580c">Loop until no more tool calls (or steer interrupts)</text>

  <!-- Step 8: Response -->
  <circle cx="60" cy="520" r="14" fill="#3b82f6"/><text x="60" y="524" text-anchor="middle" class="step">8</text>
  <rect x="80" y="502" width="300" height="40" rx="6" fill="#dbeafe" stroke="#60a5fa" filter="url(#s)"/>
  <text x="230" y="520" text-anchor="middle" class="bl">Deliver Response to Channel</text>
  <text x="230" y="533" text-anchor="middle" class="bs">Chunk + format (per-channel limits) → send</text>

  <!-- Step 9: Persist -->
  <circle cx="60" cy="570" r="14" fill="#3b82f6"/><text x="60" y="574" text-anchor="middle" class="step">9</text>
  <rect x="80" y="552" width="300" height="40" rx="6" fill="#f1f5f9" stroke="#94a3b8" filter="url(#s)"/>
  <text x="230" y="570" text-anchor="middle" class="bl">Persist to JSONL + Update Session Store</text>
  <text x="230" y="583" text-anchor="middle" class="bs">Append turn → update tokens/timestamps</text>

  <!-- Step 10: Compaction Check -->
  <circle cx="60" cy="620" r="14" fill="#8b5cf6"/><text x="60" y="624" text-anchor="middle" class="step">10</text>
  <rect x="80" y="602" width="300" height="50" rx="6" fill="#faf5ff" stroke="#c4b5fd" filter="url(#s)"/>
  <text x="230" y="620" text-anchor="middle" class="bl">Post-turn: Compaction Check</text>
  <text x="230" y="633" text-anchor="middle" class="bs">Near context limit? → memory flush → compact</text>
  <text x="230" y="645" text-anchor="middle" class="bs">Process queued followup messages</text>

  <!-- Connecting arrows -->
  <line x1="230" y1="92" x2="230" y2="102" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="142" x2="230" y2="152" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="192" x2="230" y2="202" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="242" x2="230" y2="256" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="306" x2="230" y2="318" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="366" x2="230" y2="378" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="488" x2="230" y2="502" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="542" x2="230" y2="552" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="230" y1="592" x2="230" y2="602" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>

  <!-- Tool sub-arrows -->
  <line x1="240" y1="422" x2="258" y2="422" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="400" y1="422" x2="418" y2="422" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>
  <line x1="560" y1="422" x2="578" y2="422" stroke="#475569" stroke-width="1" marker-end="url(#a)"/>

  <!-- Side: Memory flush detail -->
  <rect x="500" y="130" width="260" height="90" rx="6" fill="#fefce8" stroke="#fde047" filter="url(#s)"/>
  <text x="630" y="150" text-anchor="middle" class="bl">Memory Flush (Pre-compaction)</text>
  <text x="630" y="165" text-anchor="middle" class="bs">1. Soft threshold crossed?</text>
  <text x="630" y="178" text-anchor="middle" class="bs">2. Silent agentic turn → write to memory/</text>
  <text x="630" y="191" text-anchor="middle" class="bs">3. Model replies NO_REPLY (hidden from user)</text>
  <text x="630" y="207" text-anchor="middle" class="bs">4. One flush per compaction cycle</text>
</svg>